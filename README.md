# RePlay
Библиотека RePlay содержит инструменты для создания рекомендательных систем от предобработки данных до выбора лучшего решения. 
В Replay используется Spark, чтобы эффективно работать с большими датасетами.

RePlay поможет:
* Отфильтровать и разбить данные для обучения рекомендательной системы
* Обучить модель
* Подобрать гиперпараметры
* Оценить качество и сравнить модели
* Объединить рекомендации, полученные несколькими моделями

### Начало работы
Примеры использования библиотеки в директории `/experiments`.

### Алгоритмы, реализованные в RePlay
| Алгоритм       | Реализация train   | Реализация inference   | Описание |
| ---------------|--------------------|------------------------|-------|
|Popular Recommender        |PySpark       |PySpark       | Рекомендует популярные объекты (встречавшиеся в истории взаимодействия чаще остальных)    |
|Popular By Users           |PySpark       |PySpark       | Рекомендует объекты, которые пользователь ранее выбирал чаще всего |
|Wilson Recommender         |Python CPU    |PySpark       | Рекомендует объекты по нижней границе доверительного интервала Вильсона для доли положительных оценок     |
|Random Recommender         |PySpark       |PySpark       | Рекомендует случайные объекты или сэмлпирует с вероятностью, пропорциональной популярности объекта   |
|K-Nearest Neighbours       |PySpark       |PySpark       | Рекомендует объекты, похожие на те, с которыми у пользователя было взаимодействие
|Classifier Recommender     |PySpark       |PySpark       | Алгоритм бинарной классификации для релевантности объекта для пользователя по их признакам          |
|Alternating Least Squares  |PySpark       |PySpark       | Алгоритм матричной факторизации [Collaborative Filtering for Implicit Feedback Datasets](https://ieeexplore.ieee.org/document/4781121)           |
|Neural Matrix Factorization|Python CPU/GPU|PySpark       | Алгоритм нейросетевой матричной факторизации на базе [Neural Collaborative Filtering](https://arxiv.org/pdf/1708.05031.pdf)          |
|SLIM                       |PySpark       |PySpark       | Алгоритм, обучающий матрицу близости объектов, для восстановления матрицы взаимодействия [SLIM: Sparse Linear Methods for Top-N Recommender Systems](http://glaros.dtc.umn.edu/gkhome/fetch/papers/SLIM2011icdm.pdf)          |
|ADMM SLIM                  |PySpark       |PySpark       | Улучшение стандартного алгоритма SLIM, [ADMM SLIM: Sparse Recommendations for Many Users](ADMM SLIM: Sparse Recommendations for Many Users)          |
|MultVAE                    |Python CPU/GPU|PySpark       | Вариационный автоэнкодер, восстанавливающий вектор взаимодействий для пользователя [Variational Autoencoders for Collaborative Filtering](Variational Autoencoders for Collaborative Filtering)          |
|Word2Vec Recommender       |Python CPU/GPU|PySpark       | Рекомендатель на основе word2vec, в котором объекты сопоставляются словам, а пользователи - предложениям.          |
|Обертка LightFM            |Python CPU    |PySpark       | Обертка для обучения моделей [LightFM](https://making.lyst.com/lightfm/docs/home.html)          |
|Обертка Implicit           |Python CPU    |PySpark       | Обертка для обучения моделей [Implicit](https://implicit.readthedocs.io/en/latest/)          |
|Stack Recommender          |Python CPU + PySpark   |Python CPU + PySpark    | Модель стекинга, перевзвешивающая предсказания моделей первого уровня        |
|Двухуровневый классификатор|PySpark       |PySpark       | Классификатор, использующий для обучения эмбеддинги пользователей и объектов, полученные базовым алгоритмом (например, матричной факторизацией), и признаки пользователей и объектов, переданные пользователем.   |

Выбор алгоритма рекомендательной системы зависит от данных и требований пользователя к рекомендациям.

**Особенности данных и алгоритмы**
Чтобы выбрать алгоритм, нужно понять, к какому типу относятся данные для обучения, и насколько изменчив состав пользователей и объектов.  
- _Тип входных данных._ В качестве входных данных модели используют историю взаимодействия пользователей и объектов (коллаборативная информация) и информацию о признаках пользователей, объектов и контектста.
Использование признаковых описаний может улучшить качество рекомендаций по сравнению с решениями, использующими только историю взаимодействия, а также помочь с "холодным стартом" (рекомендациями для пользователей и объектов, отсутствующих в истории взаимодействия).
По типу входных данных алгоритмы в RePlay делятся на:
    - Collaborative, коллаборативные. Используют историю взаимодействия пользователей и объектов для построения рекомендаций. 
    - Content-based. Используют признаковые описания пользователей и объектов для построения рекомендаций.
    - Hybrid, гибридные. Используют коллаборативную информацию, признаки пользователей/объектов, результаты работы других алгоритмов.
- _Тип взаимодействия._ История взаимодействия может отражать явные предпочтения пользователя, например, оценки (explicit feedback), или неявные предпочтения, например, факт просмотра, количество прослушиваний(implicit feedback). 
    Explicit feedback может содержать информацию об отрицательных взаимодействиях, тогда как implicit feedback рассматривается как индикатор положительного взаимодействия.
    Некоторые алгоритмы RePlay игнорируют значение релевантности, переданные пользователем, и используют пары пользователь-объект из лога как одинаково релевантные взаимодействия (unary ratings). Для таких алгоритмов стоит удалить из обучающей выборки взаимодействия, которые нельзя считать положительными.
- _Постоянство пользователей._ Некоторые алгоритмы требуют переобучения модели, чтобы рекомендовать пользователям, отсутствующим в обучающей выборке.
- _Постоянство объектов._ Большинство алгоритмов требуют переобучения модели, чтобы рекомендовать объекты, отсутствующие в обучающей выборке.

| Алгоритм       | Тип данных          | Тип взаимодействия | Рекомендует для новых пользователи | Рекомендует новые объекты |
| ---------------|--------------|-------|-------|-------|
|Popular Recommender        |Collaborative    | приводятся к unary ratings             | + | - |
|Popular By Users           |Collaborative    | приводятся к unary ratings             | - | - |
|Wilson Recommender         |Collaborative    | binary ratings                         | + | - |
|Random Recommender         |Collaborative    | приводятся к unary ratings             | + | + |
|K-Nearest Neighbours       |Collaborative    | приводятся к unary ratings             | + | - |
|Classifier Recommender     |Content-based    | binary ratings                         | + | + |
|Alternating Least Squares  |Collaborative    | implicit feedback                      | - | - |
|Neural Matrix Factorization|Collaborative    | приводятся к unary ratings             | - | - |
|SLIM                       |Collaborative    | unary ratings, explicit feedback       | + | - |
|ADMM SLIM                  |Collaborative    | unary ratings, explicit feedback       | + | - |
|Mult-VAE                   |Collaborative    | приводятся к unary ratings             | + | - |
|Word2Vec Recommender       |Collaborative    | приводятся к unary ratings             | + | - |
|Обертка LightFM            |Hybrid           | [в зависимости от типа loss](https://making.lyst.com/lightfm/docs/lightfm.html#lightfm)       | + | + |
|Обертка Implicit           |Collaborative    | [в зависимости от выбранной модели](https://implicit.readthedocs.io/en/latest/index.html)    | - | - |
|Stack Recommender          | `*`             | `*`  | `*` | `*` |
|Двухуровневый классификатор|Hybrid           | приводятся к unary ratings для модели второго уровня    | `*` | `*` |

`*` - зависит от алгоритмов, используемых в качестве базовых. 

**Требования к рекомендациям и алгоритмы**
Перед выбором алгоритма стоит оценить, какие рекомендации мы ожидаем получить. 
* _Персонализированность рекомендаций._ Иногда достаточно рекомендовать новые и популярные объекты всем пользователям, но чаще рекомендации должны быть персоналазированными, то есть определяться профилем пользователя и его историей.  
* _Рекомендации для холодных пользователей_ (пользователи, которые не взаимодействовали с объектами)
* _Рекомендации для холодных объектов_ (объекты, для которых отсутствует история взаимодействия с пользователями)
* _Рекомендации новых для пользователя объектов._ Иногда достаточно порекомендовать пользователю какие-то объекты из его же истории взаимодействия. Хороший бейзлайн - рекомендации самого популярного из истории пользователя, но в классическом подходе от рекомендательной системы требуется рекомендация объектов, с которыми пользователь еще не взаимодействовал.

| Алгоритм       | Персонализированные | Холодные пользователи | Холодные объекты |  Новые объекты для пользователя |
| ---------------|--------------|-------|-------|-------|
|Popular Recommender          | - | + | - | + |
|Popular By Users             | + | - | - | - |
|Wilson Recommender           | - | + | - | + |
|Random Recommender           | - | + | + | + |
|K-Nearest Neighbours         | + | + | - | + |
|Classifier Recommender       | + | + | + | + |
|Alternating Least Squares    | + | - | - | + |
|Neural Matrix Factorization  | + | - | - | + |
|SLIM                         | + | - | - | + |
|ADMM SLIM                    | + | - | - | + |
|Mult-VAE                     | + | - | - | + |
|Word2Vec Recommender         | + | - | - | + |
|Обертка LightFM              | + | + | + | + |
|Обертка Implicit             | + | - | - | + |
|Stack Recommender            | + | `*` | `*` | `*` |
|Двухуровневый классификатор  | + | `*` | `*` | `*` |

`*` - зависит от алгоритмов, используемых в качестве базовых.

Больше информации об алгоритмах - в документации к RePlay.

### Метрики
В библиотеке реализованы метрики для оценки качества рекомендательных систем: HitRate, Precision, MAP, Recall, ROC-AUC, MRR, NDCG, Surprisal, Unexpectedness, Coverage.
Метрики можно посчитать для различных значений _k_ (числа рекомендаций для подсчета метрики), оценить среднее или медианное значение метрики по пользователям и нижнюю границу доверительного интервала.  


| Метрика       | Описание | Тип метрики | Дополнительные параметры | 
| ---------------|--------------|-------|-------|
|HitRate                      | Доля пользователей, для которых хотя бы одна рекомендация из первых K релевантна. | Метрика классификации | - |
|Precision                    | Доля релевантных рекомендаций среди первых K элементов выдачи. | Метрика классификации | - |
|Mean Average Precision, MAP  | Средний Precision по всем j <= K элементам выдачи. | Метрика ранжирования |
|Recall                       | Доля объектов из тестовой выборки, вошедших в первые K рекомендаций алгоритма. | Метрика классификации |
|ROC-AUC                      | Доля правильно упорядоченных (релевантный / нерелевантный) пар объектов среди рекомендованных. | Метрика классификации |
|Mean Reciprocal Rank, MRR    |  Средняя позиция первой релевантной рекомендации из K элементов выдачи в степени -1. | Метрика классификации |
|Normalized Discounted Cumulative Gain, NDCG| Метрика ранжирования, учитывающая позиции релевантных объектов среди первых K элементов выдачи. | Метрика ранжирования |
|Surprisal                    | Степень "редкости" (непопулярности) рекомендуемых объектов | Специализированная метрика | Лог взаимодействия для определения степени редкости объектов|
|Unexpectedness               | Доля рекомендуемых объектов, которые не содержатся в рекомендациях базового алгоритма | Специализированная метрика | Базовый алгоритм и лог взаимодействия для обучения или рекомендации базового алгоритма|
|Coverage                     | Доля объектов, которые встречаются в полученных рекомендациях| Специализированная метрика | Лог взаимодействия, содержащий все доступные объекты|

Более подробную информацию о метриках и формулах для их расчета можно найти в документации к RePlay.

### Эксперименты
Класс Experiment позволяет посчитать метрики для рекомендаций, полученных несколькими моделями, и сравнить их. 

### Сценарии
В RePlay реализованы сценарии — пайплайны, объединяющие применение нискольких модулей библиотеки, включая:
* разбиение данных на обучающую и валидационную выборки
* автоматический подбор гиперпараметров моделей
* расчёт метрик и сравнение моделей
* обучение на всём объёме данных и построение рекомендаций

## Как начать пользоваться библиотекой

### Установка
Для корректной работы необходимы python 3.6+ и java 8+. \

Клонируйте репозиторий RePlay: \
 в _sigma_:
```bash
git clone https://sbtatlas.sigma.sbrf.ru/stash/scm/ailab/replay.git
```
в _alpha_:
```bash
git clone ssh://git@stash.delta.sbrf.ru:7999/ailabrecsys/replay.git
```
 и установите библиотеку с помощью poetry:
```
cd replay
pip install --upgrade pip
pip install poetry
poetry install
```

### Проверка работы библиотеки
Запустите тесты для проверки корректности установки. \
Из директории `replay`:
```bash
pytest ./tests
```

### Документация

Запустите формирование документации из директории `replay`:
```bash
cd ./docs
mkdir -p _static
make clean html
```
Документация будет доступна в `replay/docs/_build/html/index.html`

## Как присоединиться к разработке
[Инструкция для разработчика](README_dev.md)
